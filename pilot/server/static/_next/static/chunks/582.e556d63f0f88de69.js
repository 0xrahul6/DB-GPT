"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[582,804],{92795:function(l,e,n){n.r(e);var a=n(85893),t=n(67294),i=n(577),d=n(61685),o=n(2549),s=n(40911),u=n(47556),r=n(14986),v=n(30322),c=n(48665),h=n(27015),m=n(59566),f=n(32983),x=n(63520),p=n(65908),b=n(99513),y=n(30119),j=n(39332),g=n(35392);let{Search:_}=m.default;function w(l){var e,n,i;let{editorValue:o,chartData:s,tableData:u,handleChange:r}=l,v=t.useMemo(()=>s?(0,a.jsx)("div",{className:"flex-1 overflow-auto p-3",style:{flexShrink:0,overflow:"hidden"},children:(0,a.jsx)(g.default,{...s})}):(0,a.jsx)("div",{}),[s]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1",style:{flexShrink:0,overflow:"auto"},children:(0,a.jsx)(b.Z,{value:(null==o?void 0:o.sql)||"",language:"mysql",onChange:r,thoughts:(null==o?void 0:o.thoughts)||""})}),v]}),(0,a.jsx)("div",{className:"h-96 border-[var(--joy-palette-divider)] border-t border-solid overflow-auto",children:(null==u?void 0:null===(e=u.values)||void 0===e?void 0:e.length)>0?(0,a.jsxs)(d.Z,{"aria-label":"basic table",stickyHeader:!0,children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:null==u?void 0:null===(n=u.columns)||void 0===n?void 0:n.map((l,e)=>(0,a.jsx)("th",{children:l},l+e))})}),(0,a.jsx)("tbody",{children:null==u?void 0:null===(i=u.values)||void 0===i?void 0:i.map((l,e)=>{var n;return(0,a.jsx)("tr",{children:null===(n=Object.keys(l))||void 0===n?void 0:n.map(e=>(0,a.jsx)("td",{children:l[e]},e))},e)})})]}):(0,a.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,a.jsx)(f.Z,{})})})]})}e.default=function(){var l,e,n,d,m;let[f,b]=t.useState([]),[g,k]=t.useState(""),[N,Z]=t.useState(),[S,q]=t.useState(!0),[P,C]=t.useState(),[E,O]=t.useState(),[R,D]=t.useState(),[A,T]=t.useState(),[z,B]=t.useState(),M=(0,j.useSearchParams)(),F=null==M?void 0:M.get("id"),K=null==M?void 0:M.get("scene"),{data:V,loading:Y}=(0,i.Z)(async()=>await (0,y.Tk)("/v1/editor/sql/rounds",{con_uid:F}),{onSuccess:l=>{var e,n;let a=null==l?void 0:null===(e=l.data)||void 0===e?void 0:e[(null==l?void 0:null===(n=l.data)||void 0===n?void 0:n.length)-1];a&&Z(null==a?void 0:a.round)}}),{run:$,loading:H}=(0,i.Z)(async()=>{var l,e;let n=null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name;return await (0,y.PR)("/api/v1/editor/sql/run",{db_name:n,sql:null==R?void 0:R.sql})},{manual:!0,onSuccess:l=>{var e,n;T({columns:null==l?void 0:null===(e=l.data)||void 0===e?void 0:e.colunms,values:null==l?void 0:null===(n=l.data)||void 0===n?void 0:n.values})}}),{run:J,loading:L}=(0,i.Z)(async()=>{var l,e;let n=null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name,a={db_name:n,sql:null==R?void 0:R.sql};return"chat_dashboard"===K&&(a.chart_type=null==R?void 0:R.showcase),await (0,y.PR)("/api/v1/editor/chart/run",a)},{manual:!0,ready:!!(null==R?void 0:R.sql),onSuccess:l=>{if(null==l?void 0:l.success){var e,n,a,t,i,d,o;T({columns:(null==l?void 0:null===(e=l.data)||void 0===e?void 0:null===(n=e.sql_data)||void 0===n?void 0:n.colunms)||[],values:(null==l?void 0:null===(a=l.data)||void 0===a?void 0:null===(t=a.sql_data)||void 0===t?void 0:t.values)||[]}),(null==l?void 0:null===(i=l.data)||void 0===i?void 0:i.chart_values)?C({type:null==l?void 0:null===(d=l.data)||void 0===d?void 0:d.chart_type,values:null==l?void 0:null===(o=l.data)||void 0===o?void 0:o.chart_values,title:null==R?void 0:R.title,description:null==R?void 0:R.thoughts}):C(void 0)}}}),{run:U,loading:G}=(0,i.Z)(async()=>{var l,e,n,a,t;let i=null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name;return await (0,y.PR)("/api/v1/sql/editor/submit",{conv_uid:F,db_name:i,conv_round:N,old_sql:null==E?void 0:E.sql,old_speak:null==E?void 0:E.thoughts,new_sql:null==R?void 0:R.sql,new_speak:(null===(n=null==R?void 0:null===(a=R.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===n?void 0:null===(t=n[1])||void 0===t?void 0:t.trim())||(null==R?void 0:R.thoughts)})},{manual:!0,onSuccess:l=>{(null==l?void 0:l.success)&&$()}}),{run:I,loading:Q}=(0,i.Z)(async()=>{var l,e,n,a,t,i;let d=null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name;return await (0,y.PR)("/api/v1/chart/editor/submit",{conv_uid:F,chart_title:null==R?void 0:R.title,db_name:d,old_sql:null==E?void 0:null===(n=E[z])||void 0===n?void 0:n.sql,new_chart_type:null==R?void 0:R.showcase,new_sql:null==R?void 0:R.sql,new_comment:(null===(a=null==R?void 0:null===(t=R.thoughts)||void 0===t?void 0:t.match(/^\n--(.*)\n\n$/))||void 0===a?void 0:null===(i=a[1])||void 0===i?void 0:i.trim())||(null==R?void 0:R.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:l=>{(null==l?void 0:l.success)&&J()}}),{data:W}=(0,i.Z)(async()=>{var l,e;let n=null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name;return await (0,y.Tk)("/v1/editor/db/tables",{db_name:n,page_index:1,page_size:200})},{ready:!!(null===(l=null==V?void 0:null===(e=V.data)||void 0===e?void 0:e.find(l=>l.round===N))||void 0===l?void 0:l.db_name),refreshDeps:[null===(n=null==V?void 0:null===(d=V.data)||void 0===d?void 0:d.find(l=>l.round===N))||void 0===n?void 0:n.db_name]}),{run:X}=(0,i.Z)(async l=>await (0,y.Tk)("/v1/editor/sql",{con_uid:F,round:l}),{manual:!0,onSuccess:l=>{let e;try{if(Array.isArray(null==l?void 0:l.data))e=null==l?void 0:l.data,B("0");else if("string"==typeof(null==l?void 0:l.data)){let n=JSON.parse(null==l?void 0:l.data);e=n}else e=null==l?void 0:l.data}catch(l){console.log(l)}finally{O(e),Array.isArray(e)?D(null==e?void 0:e[Number(z||0)]):D(e)}}}),ll=t.useMemo(()=>{let l=(e,n)=>e.map(e=>{let t=e.title,i=t.indexOf(g),d=t.substring(0,i),u=t.slice(i+g.length),r=i>-1?(0,a.jsx)(o.Z,{title:((null==e?void 0:e.comment)||(null==e?void 0:e.title))+((null==e?void 0:e.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[d,(0,a.jsx)("span",{className:"text-[#1677ff]",children:g}),u,(null==e?void 0:e.type)&&(0,a.jsx)(s.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==e?void 0:e.type,"]")})]})}):(0,a.jsx)(o.Z,{title:((null==e?void 0:e.comment)||(null==e?void 0:e.title))+((null==e?void 0:e.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[t,(null==e?void 0:e.type)&&(0,a.jsx)(s.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==e?void 0:e.type,"]")})]})});if(e.children){let a=n?String(n)+"_"+e.key:e.key;return{title:t,showTitle:r,key:a,children:l(e.children,a)}}return{title:t,showTitle:r,key:e.key}});return(null==W?void 0:W.data)?(b([null==W?void 0:W.data.key]),l([null==W?void 0:W.data])):[]},[g,W]),le=t.useMemo(()=>{let l=[],e=(n,a)=>{if(n&&!((null==n?void 0:n.length)<=0))for(let t=0;t<n.length;t++){let i=n[t],{key:d,title:o}=i;l.push({key:d,title:o,parentKey:a}),i.children&&e(i.children,d)}};return ll&&e(ll),l},[ll]),ln=(l,e)=>{let n;for(let a=0;a<e.length;a++){let t=e[a];t.children&&(t.children.some(e=>e.key===l)?n=t.key:ln(l,t.children)&&(n=ln(l,t.children)))}return n};function la(l){let e;if(!l)return{sql:"",thoughts:""};let n=l&&l.match(/(--.*)\n([\s\S]*)/),a="";return n&&n.length>=3&&(a=n[1],e=n[2]),{sql:e,thoughts:a}}return t.useEffect(()=>{N&&X(N)},[X,N]),t.useEffect(()=>{E&&"chat_dashboard"===K&&z&&J()},[z,K,E,J]),t.useEffect(()=>{E&&"chat_dashboard"!==K&&$()},[K,E,$]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,a.jsx)("div",{className:"bg-[#f8f8f8] border-[var(--joy-palette-divider)] border-b border-solid flex items-center px-3 justify-between",children:(0,a.jsxs)("div",{className:"absolute right-4 top-2",children:[(0,a.jsx)(u.Z,{className:"bg-[#1677ff] text-[#fff] hover:bg-[#1c558e] px-4 cursor-pointer",loading:H||L,size:"sm",onClick:async()=>{"chat_dashboard"===K?J():$()},children:"Run"}),(0,a.jsx)(u.Z,{variant:"outlined",size:"sm",className:"ml-3 px-4 cursor-pointer",loading:G||Q,onClick:async()=>{"chat_dashboard"===K?await I():await U()},children:"Save"})]})}),(0,a.jsxs)("div",{className:"flex flex-1 overflow-auto",children:[(0,a.jsxs)("div",{className:"text h-full border-[var(--joy-palette-divider)] border-r border-solid p-3 max-h-full overflow-auto",style:{width:"300px"},children:[(0,a.jsxs)("div",{className:"flex items-center py-3",children:[(0,a.jsx)(r.Z,{className:"h-4 min-w-[240px]",size:"sm",value:N,onChange:(l,e)=>{Z(e)},children:null==V?void 0:null===(m=V.data)||void 0===m?void 0:m.map(l=>(0,a.jsx)(v.Z,{value:null==l?void 0:l.round,children:null==l?void 0:l.round_name},null==l?void 0:l.round))}),(0,a.jsx)(h.Z,{className:"ml-2"})]}),(0,a.jsx)(_,{style:{marginBottom:8},placeholder:"Search",onChange:l=>{let{value:e}=l.target;if(null==W?void 0:W.data){if(e){let l=le.map(l=>l.title.indexOf(e)>-1?ln(l.key,ll):null).filter((l,e,n)=>l&&n.indexOf(l)===e);b(l)}else b([]);k(e),q(!0)}}}),ll&&ll.length>0&&(0,a.jsx)(x.Z,{onExpand:l=>{b(l),q(!1)},expandedKeys:f,autoExpandParent:S,treeData:ll,fieldNames:{title:"showTitle"}})]}),(0,a.jsx)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden",children:Array.isArray(E)?(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(c.Z,{className:"h-full",sx:{".ant-tabs-content, .ant-tabs-tabpane-active":{height:"100%"},"& .ant-tabs-card.ant-tabs-top >.ant-tabs-nav .ant-tabs-tab, & .ant-tabs-card.ant-tabs-top >div>.ant-tabs-nav .ant-tabs-tab":{borderRadius:"0"}},children:(0,a.jsx)(p.Z,{className:"h-full dark:text-white px-2",activeKey:z,onChange:l=>{B(l),D(null==E?void 0:E[Number(l)])},items:null==E?void 0:E.map((l,e)=>({key:e+"",label:null==l?void 0:l.title,children:(0,a.jsx)("div",{className:"flex flex-col h-full",children:(0,a.jsx)(w,{editorValue:l,handleChange:l=>{let{sql:e,thoughts:n}=la(l);D(l=>Object.assign({},l,{sql:e,thoughts:n}))},tableData:A,chartData:P})})}))})})}):(0,a.jsx)(w,{editorValue:E,handleChange:l=>{let{sql:e,thoughts:n}=la(l);D(l=>Object.assign({},l,{sql:e,thoughts:n}))},tableData:A,chartData:void 0})})]})]})}},30119:function(l,e,n){n.d(e,{Tk:function(){return o},PR:function(){return s},Ej:function(){return u}});var a=n(58301),t=n(6154);let i=t.Z.create({baseURL:"http://127.0.0.1:5000"});i.defaults.timeout=1e4,i.interceptors.response.use(l=>l.data,l=>Promise.reject(l)),n(96486);let d={"content-type":"application/json"},o=(l,e)=>{if(e){let n=Object.keys(e).filter(l=>void 0!==e[l]&&""!==e[l]).map(l=>"".concat(l,"=").concat(e[l])).join("&");n&&(l+="?".concat(n))}return i.get("/api"+l,{headers:d}).then(l=>l).catch(l=>{a.ZP.error(l),Promise.reject(l)})},s=(l,e)=>i.post(l,e,{headers:d}).then(l=>l).catch(l=>{a.ZP.error(l),Promise.reject(l)}),u=(l,e)=>i.post(l,e).then(l=>l).catch(l=>{a.ZP.error(l),Promise.reject(l)})}}]);