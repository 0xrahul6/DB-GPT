(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[929],{86066:function(e,l,t){Promise.resolve().then(t.bind(t,18374))},18374:function(e,l,t){"use strict";t.r(l),t.d(l,{default:function(){return eN}});var a=t(9268),n=t(86006),s=t(57931),r=t(11196),i=t(83192),o=t(35891),d=t(22046),c=t(53113),u=t(56456),h=t(24857),v=t(90545),x=t(48755),m=t(56959),f=t(76447),p=t(61469),j=t(98222),g=t(84257),y=t(8683),b=t.n(y),w=t(77055);function _(e){let{className:l,value:t,language:s="mysql",onChange:r,thoughts:i}=e,o=(0,n.useMemo)(()=>"mysql"!==s?t:i&&i.length>0?(0,w.WU)("-- ".concat(i," \n").concat(t)):(0,w.WU)(t),[t,i]);return(0,a.jsx)(g.ZP,{className:b()(l),value:o,language:s,onChange:r,theme:"vs-dark",options:{minimap:{enabled:!1},wordWrap:"on"}})}var N=t(78915),Z=t(56008),S=t(90022),k=t(8997),P=t(91440),C=t(84835),E=t.n(C),q=function(e){let{type:l,values:t,title:s,description:r}=e,o=n.useMemo(()=>{if(!((null==t?void 0:t.length)>0))return(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(f.Z,{image:f.Z.PRESENTED_IMAGE_SIMPLE,description:"图表数据为空"})});if("IndicatorValue"!==l){if("Table"===l){var e,n,s;let l=E().groupBy(t,"type");return(0,a.jsx)("div",{className:"flex-1 overflow-auto",children:(0,a.jsxs)(i.Z,{"aria-label":"basic table",hoverRow:!0,stickyHeader:!0,children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:Object.keys(l).map(e=>(0,a.jsx)("th",{children:e},e))})}),(0,a.jsx)("tbody",{children:null===(e=Object.values(l))||void 0===e?void 0:null===(n=e[0])||void 0===n?void 0:null===(s=n.map)||void 0===s?void 0:s.call(n,(e,t)=>{var n;return(0,a.jsx)("tr",{children:null===(n=Object.keys(l))||void 0===n?void 0:n.map(e=>{var n;return(0,a.jsx)("td",{children:(null==l?void 0:null===(n=l[e])||void 0===n?void 0:n[t].value)||""},e)})},t)})})]})})}return"BarChart"===l?(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsxs)(P.Chart,{autoFit:!0,data:t||[],forceUpdate:!0,children:[(0,a.jsx)(P.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,P.getTheme)().colors10[0]}}),(0,a.jsx)(P.Tooltip,{shared:!0})]})}):"LineChart"===l?(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsx)(P.Chart,{forceUpdate:!0,autoFit:!0,data:t||[],children:(0,a.jsx)(P.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})}):(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(f.Z,{image:f.Z.PRESENTED_IMAGE_SIMPLE,description:"暂不支持该图表类型"})})}},[t,l]);return"IndicatorValue"===l&&(null==t?void 0:t.length)>0?(0,a.jsx)("div",{className:"flex flex-row gap-3",children:t.map(e=>(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(S.Z,{sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"justify-around",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,a.jsx)(d.ZP,{children:"".concat(e.type,": ").concat(e.value)})]})})},e.name))}):(0,a.jsx)("div",{className:"flex-1 h-full",children:(0,a.jsx)(S.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"h-full",children:[s&&(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:s}),r&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:r}),o]})})})};let{Search:R}=m.default;function O(e){var l,t,s;let{editorValue:r,chartData:o,tableData:d,handleChange:c}=e,u=n.useMemo(()=>o?(0,a.jsx)("div",{className:"flex-1 overflow-auto p-3",style:{flexShrink:0,overflow:"hidden"},children:(0,a.jsx)(q,{...o})}):(0,a.jsx)("div",{}),[o]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,a.jsx)("div",{className:"flex-1",style:{flexShrink:0,overflow:"auto"},children:(0,a.jsx)(_,{value:(null==r?void 0:r.sql)||"",language:"mysql",onChange:c,thoughts:(null==r?void 0:r.thoughts)||""})}),u]}),(0,a.jsx)("div",{className:"h-96 border-[var(--joy-palette-divider)] border-t border-solid overflow-auto",children:(null==d?void 0:null===(l=d.values)||void 0===l?void 0:l.length)>0?(0,a.jsxs)(i.Z,{"aria-label":"basic table",stickyHeader:!0,children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:null==d?void 0:null===(t=d.columns)||void 0===t?void 0:t.map((e,l)=>(0,a.jsx)("th",{children:e},e+l))})}),(0,a.jsx)("tbody",{children:null==d?void 0:null===(s=d.values)||void 0===s?void 0:s.map((e,l)=>{var t;return(0,a.jsx)("tr",{children:null===(t=Object.keys(e))||void 0===t?void 0:t.map(l=>(0,a.jsx)("td",{children:e[l]},l))},l)})})]}):(0,a.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,a.jsx)(f.Z,{})})})]})}var A=function(){var e,l,t,s,i;let[m,f]=n.useState([]),[g,y]=n.useState([]),[b,w]=n.useState(""),[_,S]=n.useState(),[k,P]=n.useState(!0),[C,E]=n.useState(),[q,A]=n.useState(),[B,L]=n.useState(),[I,D]=n.useState(),[M,T]=n.useState(),U=(0,Z.useSearchParams)(),F=U.get("id"),V=U.get("scene"),{data:J,loading:z}=(0,r.Z)(async()=>await (0,N.Tk)("/v1/editor/sql/rounds",{con_uid:F}),{onSuccess:e=>{var l,t;let a=null==e?void 0:null===(l=e.data)||void 0===l?void 0:l[(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.length)-1];a&&S(null==a?void 0:a.round)}}),{run:W,loading:H}=(0,r.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,N.PR)("/api/v1/editor/sql/run",{db_name:t,sql:null==B?void 0:B.sql})},{manual:!0,onSuccess:e=>{var l,t;D({columns:null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.colunms,values:null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.values})}}),{run:G,loading:K}=(0,r.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name,a={db_name:t,sql:null==B?void 0:B.sql};return"chat_dashboard"===V&&(a.chart_type=null==B?void 0:B.showcase),await (0,N.PR)("/api/v1/editor/chart/run",a)},{manual:!0,ready:!!(null==B?void 0:B.sql),onSuccess:e=>{if(null==e?void 0:e.success){var l,t,a,n,s,r,i;D({columns:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:null===(t=l.sql_data)||void 0===t?void 0:t.colunms)||[],values:(null==e?void 0:null===(a=e.data)||void 0===a?void 0:null===(n=a.sql_data)||void 0===n?void 0:n.values)||[]}),(null==e?void 0:null===(s=e.data)||void 0===s?void 0:s.chart_values)?E({type:null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.chart_type,values:null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.chart_values,title:null==B?void 0:B.title,description:null==B?void 0:B.thoughts}):E(void 0)}}}),{run:$,loading:Y}=(0,r.Z)(async()=>{var e,l,t,a,n;let s=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,N.PR)("/api/v1/sql/editor/submit",{conv_uid:F,db_name:s,conv_round:_,old_sql:null==q?void 0:q.sql,old_speak:null==q?void 0:q.thoughts,new_sql:null==B?void 0:B.sql,new_speak:(null===(t=null==B?void 0:null===(a=B.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===t?void 0:null===(n=t[1])||void 0===n?void 0:n.trim())||(null==B?void 0:B.thoughts)})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&W()}}),{run:X,loading:Q}=(0,r.Z)(async()=>{var e,l,t,a,n,s;let r=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,N.PR)("/api/v1/chart/editor/submit",{conv_uid:F,chart_title:null==B?void 0:B.title,db_name:r,old_sql:null==q?void 0:null===(t=q[M])||void 0===t?void 0:t.sql,new_chart_type:null==B?void 0:B.showcase,new_sql:null==B?void 0:B.sql,new_comment:(null===(a=null==B?void 0:null===(n=B.thoughts)||void 0===n?void 0:n.match(/^\n--(.*)\n\n$/))||void 0===a?void 0:null===(s=a[1])||void 0===s?void 0:s.trim())||(null==B?void 0:B.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&G()}}),{data:ee}=(0,r.Z)(async()=>{var e,l;let t=null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name;return await (0,N.Tk)("/v1/editor/db/tables",{db_name:t,page_index:1,page_size:200})},{ready:!!(null===(e=null==J?void 0:null===(l=J.data)||void 0===l?void 0:l.find(e=>e.round===_))||void 0===e?void 0:e.db_name),refreshDeps:[null===(t=null==J?void 0:null===(s=J.data)||void 0===s?void 0:s.find(e=>e.round===_))||void 0===t?void 0:t.db_name]}),{run:el}=(0,r.Z)(async e=>await (0,N.Tk)("/v1/editor/sql",{con_uid:F,round:e}),{manual:!0,onSuccess:e=>{let l;try{if(Array.isArray(null==e?void 0:e.data))l=null==e?void 0:e.data,T("0");else if("string"==typeof(null==e?void 0:e.data)){let t=JSON.parse(null==e?void 0:e.data);l=t}else l=null==e?void 0:e.data}catch(e){console.log(e)}finally{A(l),Array.isArray(l)?L(null==l?void 0:l[Number(M||0)]):L(l)}}}),et=n.useMemo(()=>{let e=(l,t)=>l.map(l=>{let n=l.title,s=n.indexOf(b),r=n.substring(0,s),i=n.slice(s+b.length),c=s>-1?(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[r,(0,a.jsx)("span",{className:"text-[#1677ff]",children:b}),i,(null==l?void 0:l.type)&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})}):(0,a.jsx)(o.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,a.jsxs)("span",{children:[n,(null==l?void 0:l.type)&&(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})});if(l.children){let a=t?String(t)+"_"+l.key:l.key;return{title:n,showTitle:c,key:a,children:e(l.children,a)}}return{title:n,showTitle:c,key:l.key}});return(null==ee?void 0:ee.data)?(f([null==ee?void 0:ee.data.key]),e([null==ee?void 0:ee.data])):[]},[b,ee]),ea=n.useMemo(()=>{let e=[],l=(t,a)=>{if(t&&!((null==t?void 0:t.length)<=0))for(let n=0;n<t.length;n++){let s=t[n],{key:r,title:i}=s;e.push({key:r,title:i,parentKey:a}),s.children&&l(s.children,r)}};return et&&l(et),e},[et]),en=(e,l)=>{let t;for(let a=0;a<l.length;a++){let n=l[a];n.children&&(n.children.some(l=>l.key===e)?t=n.key:en(e,n.children)&&(t=en(e,n.children)))}return t};function es(e){let l;if(!e)return{sql:"",thoughts:""};let t=e&&e.match(/(--.*)\n([\s\S]*)/),a="";return t&&t.length>=3&&(a=t[1],l=t[2]),{sql:l,thoughts:a}}return n.useEffect(()=>{_&&el(_)},[el,_]),n.useEffect(()=>{q&&"chat_dashboard"===V&&M&&G()},[M,V,q,G]),n.useEffect(()=>{q&&"chat_dashboard"!==V&&W()},[V,q,W]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,a.jsx)("div",{className:"bg-[#f8f8f8] border-[var(--joy-palette-divider)] border-b border-solid flex items-center px-3 justify-between",children:(0,a.jsxs)("div",{className:"absolute right-4 top-2",children:[(0,a.jsx)(c.Z,{className:"bg-[#1677ff] text-[#fff] hover:bg-[#1c558e] px-4 cursor-pointer",loading:H||K,size:"sm",onClick:async()=>{"chat_dashboard"===V?G():W()},children:"Run"}),(0,a.jsx)(c.Z,{variant:"outlined",size:"sm",className:"ml-3 px-4 cursor-pointer",loading:Y||Q,onClick:async()=>{"chat_dashboard"===V?await X():await $()},children:"Save"})]})}),(0,a.jsxs)("div",{className:"flex flex-1 overflow-auto",children:[(0,a.jsxs)("div",{className:"text h-full border-[var(--joy-palette-divider)] border-r border-solid p-3 max-h-full overflow-auto",style:{width:"300px"},children:[(0,a.jsxs)("div",{className:"flex items-center py-3",children:[(0,a.jsx)(u.Z,{className:"h-4 min-w-[240px]",size:"sm",value:_,onChange:(e,l)=>{S(l)},children:null==J?void 0:null===(i=J.data)||void 0===i?void 0:i.map(e=>(0,a.jsx)(h.Z,{value:null==e?void 0:e.round,children:null==e?void 0:e.round_name},null==e?void 0:e.round))}),(0,a.jsx)(x.Z,{className:"ml-2"})]}),(0,a.jsx)(R,{style:{marginBottom:8},placeholder:"Search",onChange:e=>{let{value:l}=e.target;if(null==ee?void 0:ee.data){if(l){let e=ea.map(e=>e.title.indexOf(l)>-1?en(e.key,et):null).filter((e,l,t)=>e&&t.indexOf(e)===l);f(e)}else f([]);w(l),P(!0)}}}),et&&et.length>0&&(0,a.jsx)(p.Z,{onExpand:e=>{f(e),P(!1)},expandedKeys:m,autoExpandParent:k,treeData:et,fieldNames:{title:"showTitle"}})]}),(0,a.jsx)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden",children:Array.isArray(q)?(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(v.Z,{className:"h-full",sx:{".ant-tabs-content, .ant-tabs-tabpane-active":{height:"100%"},"& .ant-tabs-card.ant-tabs-top >.ant-tabs-nav .ant-tabs-tab, & .ant-tabs-card.ant-tabs-top >div>.ant-tabs-nav .ant-tabs-tab":{borderRadius:"0"}},children:(0,a.jsx)(j.Z,{className:"h-full dark:text-white px-2",activeKey:M,onChange:e=>{T(e),L(null==q?void 0:q[Number(e)])},items:null==q?void 0:q.map((e,l)=>({key:l+"",label:null==e?void 0:e.title,children:(0,a.jsx)("div",{className:"flex flex-col h-full",children:(0,a.jsx)(O,{editorValue:e,handleChange:e=>{let{sql:l,thoughts:t}=es(e);L(e=>Object.assign({},e,{sql:l,thoughts:t}))},tableData:I,chartData:C})})}))})})}):(0,a.jsx)(O,{editorValue:q,handleChange:e=>{let{sql:l,thoughts:t}=es(e);L(e=>Object.assign({},e,{sql:l,thoughts:t}))},tableData:I,chartData:void 0})})]})]})},B=t(69962),L=t(97287),I=t(73141),D=t(45642),M=t(71990),T=e=>{let l=(0,n.useReducer)((e,l)=>({...e,...l}),{...e});return l},U=t(21628),F=t(52040),V=e=>{let{queryAgentURL:l,channel:t,queryBody:a,initHistory:r=[]}=e,[i,o]=T({history:r}),d=(0,Z.useSearchParams)(),c=d.get("id"),{refreshDialogList:u}=(0,s.Cg)(),h=new AbortController;(0,n.useEffect)(()=>{r.length&&o({history:r})},[r.length]);let v=async(e,n)=>{if(!e)return;let s=[...i.history,{role:"human",context:e}],r=s.length;o({history:s});let d={conv_uid:c,...n,...a,user_input:e,channel:t};if(!(null==d?void 0:d.conv_uid)){U.ZP.error("conv_uid 不存在，请刷新后重试");return}try{await (0,M.L)("".concat(F.env.API_BASE_URL?F.env.API_BASE_URL:"").concat("/api"+l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d),signal:h.signal,openWhenHidden:!0,async onopen(e){if(s.length<=1){var l;u();let e=new URLSearchParams(window.location.search);e.delete("initMessage"),null===(l=window.history)||void 0===l||l.replaceState(null,"","?".concat(e.toString()))}(!e.ok||e.headers.get("content-type")!==M.a)&&e.status>=400&&e.status<500&&429!==e.status&&e.status},onclose(){console.log("onclose")},onerror(e){throw console.log("onerror"),Error(e)},onmessage:e=>{var l,t,a;if(e.data=null===(l=e.data)||void 0===l?void 0:l.replaceAll("\\n","\n"),"[DONE]"===e.data);else if(null===(t=e.data)||void 0===t?void 0:t.startsWith("[ERROR]"))o({history:[...s,{role:"view",context:null===(a=e.data)||void 0===a?void 0:a.replace("[ERROR]","")}]});else{let l=[...s];e.data&&((null==l?void 0:l[r])?l[r].context="".concat(e.data):l.push({role:"view",context:e.data}),o({history:l}))}}})}catch(e){console.log(e),o({history:[...s,{role:"view",context:"Sorry, We meet some error, please try agin later."}]})}};return{handleChatSubmit:v,history:i.history}},J=t(54842),z=t(94244),W=t(35086),H=t(53047),G=t(81486),K=t(82144),$=t(19700),Y=t(71563),X=t(86362),Q=t(50946),ee=t(52276),el=t(24946),et=t(98479),ea=t(81616),en=t(30297),es=function(e){var l;let{convUid:t,chatMode:s,onComplete:r,...i}=e,[o,d]=(0,n.useState)(!1),[c,u]=(0,n.useState)([]),[h,v]=(0,n.useState)(),[x,m]=(0,n.useState)(),f=async e=>{var l;if(!e){U.ZP.error("Please select the *.(csv|xlsx|xls) file");return}if(!/\.(csv|xlsx|xls)$/.test(null!==(l=e.file.name)&&void 0!==l?l:"")){U.ZP.error("File type must be csv, xlsx or xls");return}u([e.file])},p=async()=>{d(!0),m("normal");try{let e=new FormData;e.append("doc_file",c[0]);let[l]=await (0,en.Vx)((0,en.qn)({convUid:t,chatMode:s,data:e,config:{timeout:36e5,onUploadProgress:e=>{let l=Math.ceil(e.loaded/(e.total||0)*100);v(l)}}}));if(l)return;U.ZP.success("success"),m("success"),null==r||r()}catch(e){m("exception"),U.ZP.error((null==e?void 0:e.message)||"Upload Error")}finally{d(!1)}};return(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)(Y.Z,{placement:"topLeft",title:"Files cannot be changed after upload",children:(0,a.jsx)(X.default,{disabled:o,className:"mr-1",beforeUpload:()=>!1,fileList:c,name:"file",accept:".csv,.xlsx,.xls",multiple:!1,onChange:f,showUploadList:{showDownloadIcon:!1,showPreviewIcon:!1,showRemoveIcon:!1},itemRender:()=>(0,a.jsx)(a.Fragment,{}),...i,children:(0,a.jsx)(Q.ZP,{className:"flex justify-center items-center dark:bg-[#4e4f56] dark:text-gray-200",disabled:o,icon:(0,a.jsx)(el.Z,{}),children:"Select File"})})}),(0,a.jsx)(Q.ZP,{type:"primary",loading:o,className:"flex justify-center items-center",disabled:!c.length,icon:(0,a.jsx)(et.Z,{}),onClick:p,children:o?100===h?"Analysis":"Uploading":"Upload"})]}),!!c.length&&(0,a.jsxs)("div",{className:"mt-2 text-gray-500 text-sm flex items-center",children:[(0,a.jsx)(ea.Z,{className:"mr-2"}),(0,a.jsx)("span",{children:null===(l=c[0])||void 0===l?void 0:l.name})]}),"number"==typeof h&&(0,a.jsx)(ee.Z,{className:"mb-0",percent:h,size:"small",status:x})]})},er=function(e){let{onComplete:l}=e,t=(0,Z.useSearchParams)(),n=t.get("id"),r=t.get("scene"),{currentDialogue:i}=(0,s.Cg)();return"chat_excel"!==r?null:(0,a.jsx)("div",{className:"w-full py-4 flex items-center border-b border-gray-100",children:(0,a.jsx)("div",{className:"w-full lg:w-4/5 xl:w-3/4 mx-auto",children:i?(0,a.jsxs)("div",{className:"flex overflow-hidden rounded",children:[(0,a.jsx)("div",{className:"flex items-center justify-center px-3 py-2 bg-gray-600",children:(0,a.jsx)(ea.Z,{className:"text-white"})}),(0,a.jsx)("div",{className:"bg-gray-100 px-3 py-2 text-xs rounded-tr rounded-br dark:text-gray-800",children:i.select_param})]}):(0,a.jsx)(es,{convUid:n,chatMode:r,onComplete:l})})})},ei=t(311),eo=t(99744),ed=t(33356),ec=t(42599),eu=t(49064),eh=t(99398);let ev={overrides:{code:e=>{let{children:l,className:t}=e;return(0,a.jsx)(eh.Z,{language:"javascript",style:eu.Z,children:l})},img:{props:{className:"my-2 !max-h-none"}},table:{props:{className:"my-2 border-collapse border border-slate-400 dark:border-slate-500 bg-white dark:bg-slate-800 text-sm shadow-sm"}},thead:{props:{className:"bg-slate-50 dark:bg-slate-700"}},th:{props:{className:"border border-slate-300 dark:border-slate-600 font-semibold !p-4 text-slate-900 dark:text-slate-200 !text-left whitespace-pre-wrap"}},td:{props:{className:"border border-slate-300 dark:border-slate-700 !p-4 text-slate-500 dark:text-slate-400 !text-left whitespace-pre-wrap"}}},wrapper:n.Fragment,namedCodesToUnicode:{amp:"&",apos:"'",gt:">",lt:"<",nbsp:"\xa0",quot:"“"}};var ex=function(e){let{context:l,isChartChat:t,isRobbort:n,onLinkClick:s}=e;return(0,a.jsxs)("div",{className:"overflow-x-auto w-full lg:w-4/5 xl:w-3/4 mx-auto flex px-2 py-2 sm:px-4 sm:py-6 rounded-xl ".concat(n?"bg-slate-100 dark:bg-[#353539]":""),children:[(0,a.jsx)("div",{className:"mr-2 flex items-center justify-center h-7 w-7 rounded-full text-lg sm:mr-4",children:n?(0,a.jsx)(eo.Z,{}):(0,a.jsx)(ed.Z,{})}),(0,a.jsxs)("div",{className:"flex-1 items-center text-md leading-7",children:[t&&"object"==typeof l&&(0,a.jsxs)(a.Fragment,{children:["[".concat(l.template_name,"]: "),(0,a.jsx)(ei.Z,{sx:{color:"#1677ff"},component:"button",onClick:s,children:l.template_introduce||"More Details"})]}),"string"==typeof l&&(0,a.jsx)(ec.Z,{options:ev,children:l.replaceAll("\\n","\n")})]})]})},em=e=>{let{messages:l,onSubmit:t,paramsObj:r={},onRefreshHistory:i,clearIntialMessage:o}=e,d=(0,Z.useSearchParams)(),v=d.get("initMessage"),x=d.get("spaceNameOriginal"),m=d.get("scene"),{currentDialogue:f}=(0,s.Cg)(),p="chat_dashboard"===m,[j,g]=(0,n.useState)(!1),[y,b]=(0,n.useState)(""),[w,N]=(0,n.useState)(!1),[S,k]=(0,n.useState)(),[P,C]=(0,n.useState)(l),[q,R]=(0,n.useState)(""),O=(0,n.useRef)(null),A=(0,n.useMemo)(()=>Object.entries(r).map(e=>{let[l,t]=e;return{key:l,value:t}}),[r]),B=(0,$.cI)(),L=async e=>{let{query:l}=e;try{g(!0),B.reset(),await t(l,{select_param:"chat_excel"===m?null==f?void 0:f.select_param:r[y]})}catch(e){}finally{g(!1)}},I=async()=>{try{var e;let l=new URLSearchParams(window.location.search),t=l.get("initMessage");l.delete("initMessage"),null===(e=window.history)||void 0===e||e.replaceState(null,"","?".concat(l.toString())),await L({query:t})}catch(e){console.log(e)}finally{null==o||o()}},D=e=>{let l=e;try{l=JSON.parse(e)}catch(e){console.log(e)}return l};return(0,n.useEffect)(()=>{O.current&&O.current.scrollTo(0,O.current.scrollHeight)},[null==l?void 0:l.length]),(0,n.useEffect)(()=>{v&&l.length<=0&&I()},[v,l.length]),(0,n.useEffect)(()=>{(null==A?void 0:A.length)&&b(x||A[0].value)},[null==A?void 0:A.length]),(0,n.useEffect)(()=>{if(p){let e=E().cloneDeep(l);e.forEach(e=>{(null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context)&&(e.context=D(null==e?void 0:e.context))}),C(e.filter(e=>["view","human"].includes(e.role)))}else C(l.filter(e=>["view","human"].includes(e.role)))},[p,l.length]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(er,{onComplete:()=>{null==o||o(),null==i||i()}}),(0,a.jsx)("div",{ref:O,className:"flex flex-1 overflow-y-auto pb-8 w-full flex-col",children:(0,a.jsxs)("div",{className:"flex items-center flex-1 flex-col text-sm leading-6 text-slate-900 dark:text-slate-300 sm:text-base sm:leading-7",children:[null==P?void 0:P.map((e,l)=>(0,a.jsx)(ex,{context:e.context,isChartChat:p,isRobbort:"view"===e.role,onLinkClick:()=>{N(!0),k(l),R(JSON.stringify(null==e?void 0:e.context,null,2))}},l)),j&&(0,a.jsx)(z.Z,{variant:"soft",color:"neutral",size:"sm",sx:{mx:"auto",my:2}})]})}),(0,a.jsx)("div",{className:"relative after:absolute after:-top-8 after:h-8 after:w-full after:bg-gradient-to-t after:from-white after:to-transparent dark:after:from-[#212121]",children:(0,a.jsxs)("form",{className:"flex w-full lg:w-4/5 xl:w-3/4 mx-auto py-2 sm:pt-6 sm:pb-10",onSubmit:e=>{e.stopPropagation(),B.handleSubmit(L)(e)},children:[!!(null==A?void 0:A.length)&&(0,a.jsx)("div",{className:"flex items-center max-w-[6rem] sm:max-w-[12rem] h-12 mr-2",children:(0,a.jsx)(u.Z,{className:"h-full w-full",value:y,onChange:(e,l)=>{b(null!=l?l:"")},children:A.map(e=>(0,a.jsx)(h.Z,{value:e.value,children:e.key},e.key))})}),(0,a.jsx)(W.ZP,{disabled:"chat_excel"===m&&!(null==f?void 0:f.select_param),className:"flex-1 h-12",variant:"outlined",endDecorator:(0,a.jsx)(H.ZP,{type:"submit",disabled:j,children:(0,a.jsx)(J.Z,{})}),...B.register("query")})]})}),(0,a.jsx)(G.Z,{open:w,onClose:()=>{N(!1)},children:(0,a.jsxs)(K.Z,{className:"w-1/2 h-[600px] flex items-center justify-center","aria-labelledby":"variant-modal-title","aria-describedby":"variant-modal-description",children:[(0,a.jsx)(_,{className:"w-full h-[500px]",language:"json",value:q}),(0,a.jsx)(c.Z,{variant:"outlined",className:"w-full mt-2",onClick:()=>N(!1),children:"OK"})]})})]})};function ef(e){let{key:l,chart:t}=e;return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(S.Z,{className:"h-full",sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:t.chart_name}),(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:t.chart_desc}),(0,a.jsx)("div",{className:"h-[300px]",children:(0,a.jsx)(P.Chart,{autoFit:!0,data:t.values,children:(0,a.jsx)(P.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})})]})})},l)}function ep(e){let{key:l,chart:t}=e;return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(S.Z,{className:"h-full",sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:t.chart_name}),(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:t.chart_desc}),(0,a.jsx)("div",{className:"h-[300px]",children:(0,a.jsxs)(P.Chart,{autoFit:!0,data:t.values,children:[(0,a.jsx)(P.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,P.getTheme)().colors10[0]}}),(0,a.jsx)(P.Tooltip,{shared:!0})]})})]})})},l)}function ej(e){var l,t;let{key:n,chart:s}=e,r=(0,C.groupBy)(s.values,"type");return(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsx)(S.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"h-full",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:s.chart_name}),"\xb7",(0,a.jsx)(d.ZP,{gutterBottom:!0,level:"body3",children:s.chart_desc}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)(i.Z,{"aria-label":"basic table",stripe:"odd",hoverRow:!0,borderAxis:"bothBetween",children:[(0,a.jsx)("thead",{children:(0,a.jsx)("tr",{children:Object.keys(r).map(e=>(0,a.jsx)("th",{children:e},e))})}),(0,a.jsx)("tbody",{children:null===(l=Object.values(r))||void 0===l?void 0:null===(t=l[0])||void 0===t?void 0:t.map((e,l)=>{var t;return(0,a.jsx)("tr",{children:null===(t=Object.keys(r))||void 0===t?void 0:t.map(e=>{var t;return(0,a.jsx)("td",{children:(null==r?void 0:null===(t=r[e])||void 0===t?void 0:t[l].value)||""},e)})},l)})})]})})]})})},n)}let eg=()=>(0,a.jsxs)(S.Z,{className:"h-full w-full flex bg-transparent",children:[(0,a.jsx)(B.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(B.Z,{animation:"wave",variant:"text",level:"body2"}),(0,a.jsx)(L.Z,{ratio:"21/9",className:"flex-1",sx:{["& .".concat(I.Z.content)]:{height:"100%"}},children:(0,a.jsx)(B.Z,{variant:"overlay",className:"h-full"})})]});var ey=()=>{let[e,l]=(0,n.useState)(),t=(0,Z.useSearchParams)(),{currentDialogue:i,refreshDialogList:o}=(0,s.Cg)(),c=t.get("id"),u=t.get("scene"),{data:h=[],run:x}=(0,r.Z)(async()=>{let[,e]=await (0,en.Vx)((0,en.j8)(c));return null!=e?e:[]},{ready:!!c,refreshDeps:[c]}),{data:m,run:f}=(0,r.Z)(async()=>await (0,N.Tk)("/v1/chat/db/list"),{ready:!!u&&!!["chat_with_db_execute","chat_with_db_qa"].includes(u)}),{history:p,handleChatSubmit:j}=V({queryAgentURL:"/v1/chat/completions",queryBody:{conv_uid:c,chat_mode:u||"chat_normal"},initHistory:h}),{data:g={}}=(0,r.Z)(async()=>{let[,e]=await (0,en.Vx)((0,en.vD)(u));return null!=e?e:{}},{ready:!!u,refreshDeps:[c,u]});(0,n.useEffect)(()=>{try{var e;let t=null==p?void 0:null===(e=p[p.length-1])||void 0===e?void 0:e.context,a=JSON.parse(t);l((null==a?void 0:a.template_name)==="report"?null==a?void 0:a.charts:void 0)}catch(e){l(void 0)}},[p.length]);let y=(0,n.useMemo)(()=>{if(e){let l=[],t=null==e?void 0:e.filter(e=>"IndicatorValue"===e.chart_type);t.length>0&&l.push({charts:t,type:"IndicatorValue"});let a=null==e?void 0:e.filter(e=>"IndicatorValue"!==e.chart_type),n=a.length,s=0;return[[0],[1],[2],[1,2],[1,3],[2,1,2],[2,1,3],[3,1,3],[3,2,3]][n].forEach(e=>{if(e>0){let t=a.slice(s,s+e);s+=e,l.push({charts:t})}}),l}},[e]);return(0,a.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[e&&(0,a.jsx)("div",{className:"w-3/4",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:null==y?void 0:y.map((e,l)=>(0,a.jsx)("div",{className:"".concat((null==e?void 0:e.type)!=="IndicatorValue"?"flex gap-3":""),children:e.charts.map(e=>"IndicatorValue"===e.chart_type?(0,a.jsx)("div",{className:"flex flex-row gap-3",children:e.values.map(e=>(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(S.Z,{sx:{background:"transparent"},children:(0,a.jsxs)(k.Z,{className:"justify-around",children:[(0,a.jsx)(d.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,a.jsx)(d.ZP,{children:e.value})]})})},e.name))},e.chart_uid):"LineChart"===e.chart_type?(0,a.jsx)(ef,{chart:e},e.chart_uid):"BarChart"===e.chart_type?(0,a.jsx)(ep,{chart:e},e.chart_uid):"Table"===e.chart_type?(0,a.jsx)(ej,{chart:e},e.chart_uid):void 0)},"chart_row_".concat(l)))})}),!e&&"chat_dashboard"===u&&(0,a.jsx)("div",{className:"w-3/4 p-6",children:(0,a.jsx)("div",{className:"flex flex-col gap-3 h-full",children:(0,a.jsxs)(D.Z,{container:!0,spacing:2,sx:{flexGrow:1},children:[(0,a.jsx)(D.Z,{xs:8,children:(0,a.jsx)(v.Z,{className:"h-full w-full",sx:{display:"flex",gap:2},children:(0,a.jsx)(eg,{})})}),(0,a.jsx)(D.Z,{xs:4,children:(0,a.jsx)(eg,{})}),(0,a.jsx)(D.Z,{xs:4,children:(0,a.jsx)(eg,{})}),(0,a.jsx)(D.Z,{xs:8,children:(0,a.jsx)(eg,{})})]})})}),(0,a.jsx)("div",{className:"".concat("chat_dashboard"===u?"w-1/3":"w-full"," flex flex-1 flex-col h-full"),children:(0,a.jsx)(em,{clearIntialMessage:async()=>{await o()},dbList:null==m?void 0:m.data,runDbList:f,onRefreshHistory:x,messages:p,onSubmit:j,paramsObj:g,setChartsData:l})})]})},eb=t(32093),ew=t(97237);function e_(){let{isContract:e,setIsContract:l}=(0,s.Cg)();return(0,a.jsxs)("div",{className:"relative w-56 h-10 mx-auto p-2 flex justify-center items-center bg-[#ece9e0] rounded-3xl model-tab dark:text-violet-600 z-10 ".concat(e?"editor-tab":""),children:[(0,a.jsxs)("div",{className:"z-10 w-[50%] text-center cursor-pointer",onClick:()=>{l(!1)},children:[(0,a.jsx)("span",{children:"Preview"}),(0,a.jsx)(ew.Z,{className:"ml-1"})]}),(0,a.jsxs)("div",{className:"z-10 w-[50%] text-center cursor-pointer",onClick:()=>{l(!0)},children:[(0,a.jsx)("span",{children:"Editor"}),(0,a.jsx)(eb.Z,{className:"ml-1"})]})]})}t(95389);var eN=()=>{let{isContract:e,setIsContract:l,setIsMenuExpand:t}=(0,s.Cg)(),r=(0,Z.useSearchParams)(),i=r.get("scene"),o=r.get("id"),d=i&&["chat_with_db_execute","chat_dashboard"].includes(i);return(0,n.useEffect)(()=>{t("chat_dashboard"!==i),o&&i&&l(!1)},[o,i,t,l]),(0,a.jsxs)(a.Fragment,{children:[d&&(0,a.jsx)("div",{className:"leading-[3rem] text-right h-12 flex justify-center",children:(0,a.jsx)("div",{className:"flex items-center cursor-pointer",children:(0,a.jsx)(e_,{})})}),e?(0,a.jsx)(A,{}):(0,a.jsx)(ey,{})]})}},57931:function(e,l,t){"use strict";t.d(l,{ZP:function(){return c},Cg:function(){return o}});var a=t(9268),n=t(11196),s=t(86006),r=t(56008),i=t(30297);let[o,d]=function(){let e=s.createContext(void 0);return[function(){let l=s.useContext(e);if(void 0===l)throw Error("useCtx must be inside a Provider with a value");return l},e.Provider]}();var c=e=>{let{children:l}=e,t=(0,r.useSearchParams)(),o=t.get("id"),c=t.get("scene"),[u,h]=s.useState(!1),[v,x]=s.useState("chat_dashboard"!==c),{run:m,data:f=[],refresh:p}=(0,n.Z)(async()=>{let[,e]=await (0,i.Vx)((0,i.Js)());return null!=e?e:[]},{manual:!0}),j=(0,s.useMemo)(()=>f.find(e=>e.conv_uid===o),[o,f]);return(0,a.jsx)(d,{value:{isContract:u,isMenuExpand:v,dialogueList:f,setIsContract:h,setIsMenuExpand:x,queryDialogueList:m,refreshDialogList:p,currentDialogue:j},children:l})}},30297:function(e,l,t){"use strict";t.d(l,{HT:function(){return j},a4:function(){return g},Vx:function(){return r},XN:function(){return i},BJ:function(){return o},Js:function(){return h},j8:function(){return x},rw:function(){return u},LM:function(){return d},G9:function(){return c},qn:function(){return m},vD:function(){return v}});var a,n=t(24214),s=t(21628);let r=(e,l)=>e.then(e=>{let{data:t}=e;if(!t)throw Error("Network Error!");if(!t.success&&l&&"*"!==l&&t.err_code&&l.includes(t.err_code)){var a;throw s.ZP.error(t.err_msg),Error(null!==(a=t.err_msg)&&void 0!==a?a:"")}return[null,t.data,t,e]}).catch(e=>[e,null,null,null]),i=()=>j("/chat/db/list"),o=()=>j("/chat/db/support/type"),d=e=>g("/chat/db/delete?db_name=".concat(e),void 0),c=e=>g("/chat/db/edit",e),u=e=>g("/chat/db/add",e),h=()=>j("/chat/dialogue/list"),v=e=>g("/chat/mode/params/list?chat_mode=".concat(e)),x=e=>j("/chat/dialogue/messages/history?con_uid=".concat(e)),m=e=>{let{convUid:l,chatMode:t,data:a,config:n}=e;return g("/chat/mode/params/file/load?conv_uid=".concat(l,"&chat_mode=").concat(t),a,{headers:{"Content-Type":"multipart/form-data"},...n})};var f=t(52040);let p=n.Z.create({baseURL:"".concat(null!==(a=f.env.API_BASE_URL)&&void 0!==a?a:"","/api/v1"),timeout:1e4}),j=(e,l,t)=>p.get(e,{params:l,...t}),g=(e,l,t)=>p.post(e,l,t)},78915:function(e,l,t){"use strict";t.d(l,{Tk:function(){return c},Kw:function(){return u},PR:function(){return h},Ej:function(){return v}});var a=t(21628),n=t(24214),s=t(52040);let r=n.Z.create({baseURL:s.env.API_BASE_URL});r.defaults.timeout=1e4,r.interceptors.response.use(e=>e.data,e=>Promise.reject(e));var i=t(84835);let o={"content-type":"application/json"},d=e=>{if(!(0,i.isPlainObject)(e))return JSON.stringify(e);let l={...e};for(let e in l){let t=l[e];"string"==typeof t&&(l[e]=t.trim())}return JSON.stringify(l)},c=(e,l)=>{if(l){let t=Object.keys(l).filter(e=>void 0!==l[e]&&""!==l[e]).map(e=>"".concat(e,"=").concat(l[e])).join("&");t&&(e+="?".concat(t))}return r.get("/api"+e,{headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},u=(e,l)=>{let t=d(l);return r.post("/api"+e,{body:t,headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},h=(e,l)=>r.post(e,l,{headers:o}).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)}),v=(e,l)=>r.post(e,l).then(e=>e).catch(e=>{a.ZP.error(e),Promise.reject(e)})},95389:function(){}},function(e){e.O(0,[180,757,355,932,358,649,191,230,715,569,196,86,579,631,767,686,822,959,585,253,769,744],function(){return e(e.s=86066)}),_N_E=e.O()}]);