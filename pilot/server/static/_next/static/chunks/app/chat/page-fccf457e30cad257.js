(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1929],{86066:function(e,l,t){Promise.resolve().then(t.bind(t,11453))},11453:function(e,l,t){"use strict";t.r(l),t.d(l,{default:function(){return ep}});var n=t(9268),a=t(86006),i=t(57931),r=t(44972),s=t(89081),o=t(83192),d=t(35891),c=t(22046),u=t(71451),v=t(24857),h=t(53113),x=t(90545),m=t(48755),f=t(56959),p=t(76447),g=t(61469),j=t(57746);function y(){}function b(e){let{width:l="100%",height:i="100%",value:r,defaultValue:s,language:o,theme:d,options:c,overrideServices:u,editorWillMount:v,editorDidMount:h,editorWillUnmount:x,className:m,description:f,uri:p,editorInstanceRef:g,handleChange:j}=e,y=a.useMemo(()=>{if("function"==typeof(null==window?void 0:window.fetch)){let e=t(12116);return e}},[]),b=(0,a.useRef)(null),w=(0,a.useRef)(null),Z=(0,a.useRef)(null),N=(0,a.useRef)(null),_=a.useMemo(()=>({width:l,height:i,overflow:"hidden"}),[l,i]),S=()=>{let e=null==v?void 0:v(y);return e||{}},P=()=>{if(!(null==w?void 0:w.current)){console.error("Can not get editor element!");return}if(null==h||h(null==w?void 0:w.current,y),null==g||g(null==w?void 0:w.current),Z){var e,l;Z.current=null==w?void 0:null===(e=w.current)||void 0===e?void 0:null===(l=e.onDidChangeModelContent)||void 0===l?void 0:l.call(e,e=>{if(!N.current){var l,t,n,a;let e=null==w?void 0:null===(l=w.current)||void 0===l?void 0:l.getModel(),i=null==w?void 0:null===(t=w.current)||void 0===t?void 0:t.getVisibleRanges(),r=null==e?void 0:e.getDecorationsInRange(null==i?void 0:i[0]);if(r){let l;for(let e=0;e<(null==r?void 0:r.length);e++){let t=r[e],n=t.options;n&&"my-description"===n.className&&(l=t)}if(l){let t=null==e?void 0:e.getValueInRange(new y.Range(l.range.startLineNumber,1,l.range.endLineNumber+1,1)),n=null==e?void 0:e.getLinesContent(),a=null==n?void 0:n.slice(l.range.endLineNumber);j(null==a?void 0:a.join("\n"),t);return}}null==j||j(null==w?void 0:null===(n=w.current)||void 0===n?void 0:null===(a=n.getValue)||void 0===a?void 0:a.call(n),void 0)}})}},k=()=>{if(!(null==w?void 0:w.current)){console.error("Can not get editor element!");return}null==x||x(null==w?void 0:w.current,y)};return(0,a.useEffect)(()=>{let e=null!==r?r:s;if(b.current){let l={...c,...S()},t=null==p?void 0:p(y),n=t&&y.editor.getModel(t);n?(n.setValue(e),y.editor.setModelLanguage(n,o)):n=y.editor.createModel(e,o,t),w.current=y.editor.create(b.current,{model:n,...m?{extraEditorClassName:m}:{},...l,...d?{theme:d}:{},automaticLayout:!0},u),P()}},[]),(0,a.useEffect)(()=>{if(w.current){var e;let l=w.current.getModel();N.current=!0,w.current.pushUndoStop(),null==l||l.pushEditOperations([],[{range:null==l?void 0:l.getFullModelRange(),text:"\n".concat(f?"-- "+f:"","\n\n")+r}],void 0);let t=null==w?void 0:null===(e=w.current)||void 0===e?void 0:e.getVisibleRanges(),n=null==l?void 0:l.getDecorationsInRange(null==t?void 0:t[0]),a=[];null==n||n.forEach(e=>{var l;(null==e?void 0:null===(l=e.options)||void 0===l?void 0:l.className)==="my-description"&&a.push(e.id)}),null==l||l.deltaDecorations(a,[{range:new y.Range(1,1,3,1),options:{before:{content:"-- 注释开始"},after:{content:"-- 注释结束"},className:"my-description"}}]),w.current.pushUndoStop(),N.current=!1}},[r,f]),(0,a.useEffect)(()=>{if(w.current){let e=w.current.getModel();y.editor.setModelLanguage(e,o)}},[o]),(0,a.useEffect)(()=>{if(w.current){let{model:e,...l}=c;w.current.updateOptions({...m?{extraEditorClassName:m}:{},...l,wordWrap:"on"})}},[m,c]),(0,a.useEffect)(()=>{y.editor.setTheme(d)},[d]),(0,a.useEffect)(()=>()=>{if(w.current){k(),w.current.dispose();let e=w.current.getModel();e&&e.dispose()}Z.current&&Z.current.dispose()},[]),(0,n.jsx)("div",{ref:b,className:"react-monaco-editor-container",style:_})}b.defaultProps={value:null,defaultValue:"",language:"javascript",theme:null,options:{},overrideServices:{},editorWillMount:y,editorDidMount:y,editorWillUnmount:y,onChange:y,className:null},b.displayName="MonacoEditor";var w=t(89749),Z=t(56008),N=t(90022),_=t(8997),S=t(91440),P=t(84835),k=t.n(P),C=function(e){let{type:l,values:t,title:i,description:r}=e,s=a.useMemo(()=>{if(!((null==t?void 0:t.length)>0))return(0,n.jsx)("div",{className:"h-full",children:(0,n.jsx)(p.Z,{image:p.Z.PRESENTED_IMAGE_SIMPLE,description:"图表数据为空"})});if("IndicatorValue"!==l){if("Table"===l){var e,a,i;let l=k().groupBy(t,"type");return(0,n.jsx)("div",{className:"flex-1 overflow-auto",children:(0,n.jsxs)(o.Z,{"aria-label":"basic table",hoverRow:!0,stickyHeader:!0,children:[(0,n.jsx)("thead",{children:(0,n.jsx)("tr",{children:Object.keys(l).map(e=>(0,n.jsx)("th",{children:e},e))})}),(0,n.jsx)("tbody",{children:null===(e=Object.values(l))||void 0===e?void 0:null===(a=e[0])||void 0===a?void 0:null===(i=a.map)||void 0===i?void 0:i.call(a,(e,t)=>{var a;return(0,n.jsx)("tr",{children:null===(a=Object.keys(l))||void 0===a?void 0:a.map(e=>{var a;return(0,n.jsx)("td",{children:(null==l?void 0:null===(a=l[e])||void 0===a?void 0:a[t].value)||""},e)})},t)})})]})})}return"BarChart"===l?(0,n.jsx)("div",{className:"flex-1 h-full",children:(0,n.jsxs)(S.Chart,{autoFit:!0,data:t||[],forceUpdate:!0,children:[(0,n.jsx)(S.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,S.getTheme)().colors10[0]}}),(0,n.jsx)(S.Tooltip,{shared:!0})]})}):"LineChart"===l?(0,n.jsx)("div",{className:"flex-1 h-full",children:(0,n.jsx)(S.Chart,{forceUpdate:!0,autoFit:!0,data:t||[],children:(0,n.jsx)(S.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})}):(0,n.jsx)("div",{className:"h-full",children:(0,n.jsx)(p.Z,{image:p.Z.PRESENTED_IMAGE_SIMPLE,description:"暂不支持该图表类型"})})}},[t,l]);return"IndicatorValue"===l&&(null==t?void 0:t.length)>0?(0,n.jsx)("div",{className:"flex flex-row gap-3",children:t.map(e=>(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)(N.Z,{sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"justify-around",children:[(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,n.jsx)(c.ZP,{children:"".concat(e.type,": ").concat(e.value)})]})})},e.name))}):(0,n.jsx)("div",{className:"flex-1 h-full",children:(0,n.jsx)(N.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"h-full",children:[i&&(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:i}),r&&(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",children:r}),s]})})})};let{Search:E}=f.default;function R(e){var l,t,i;let{editorValue:r,chartData:s,tableData:d,handleChange:c}=e,u=a.useMemo(()=>s?(0,n.jsx)("div",{className:"flex-1 overflow-auto p-3",style:{flexShrink:0,overflow:"hidden"},children:(0,n.jsx)(C,{...s})}):(0,n.jsx)("div",{}),[s]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex-1 flex overflow-hidden",children:[(0,n.jsx)("div",{className:"flex-1",style:{flexShrink:0,overflow:"auto"},children:(0,n.jsx)(b,{value:null==r?void 0:r.sql,language:"mysql",handleChange:c,description:null==r?void 0:r.thoughts})}),u]}),(0,n.jsx)("div",{className:"h-60 border-[var(--joy-palette-divider)] border-t border-solid overflow-auto",children:(null==d?void 0:null===(l=d.values)||void 0===l?void 0:l.length)>0?(0,n.jsxs)(o.Z,{"aria-label":"basic table",stickyHeader:!0,children:[(0,n.jsx)("thead",{children:(0,n.jsx)("tr",{children:null==d?void 0:null===(t=d.columns)||void 0===t?void 0:t.map((e,l)=>(0,n.jsx)("th",{children:e},e+l))})}),(0,n.jsx)("tbody",{children:null==d?void 0:null===(i=d.values)||void 0===i?void 0:i.map((e,l)=>{var t;return(0,n.jsx)("tr",{children:null===(t=Object.keys(e))||void 0===t?void 0:t.map(l=>(0,n.jsx)("td",{children:e[l]},l))},l)})})]}):(0,n.jsx)("div",{className:"h-full flex justify-center items-center",children:(0,n.jsx)(p.Z,{})})})]})}var O=function(){var e,l,t,i,r;let[o,f]=a.useState([]),[p,y]=a.useState(""),[b,N]=a.useState(),[_,S]=a.useState(!0),[P,k]=a.useState(),[C,O]=a.useState(),[M,q]=a.useState(),[L,T]=a.useState(),[D,I]=a.useState(),B=(0,Z.useSearchParams)(),F=B.get("id"),A=B.get("scene"),{data:U,loading:V}=(0,s.Z)(async()=>await (0,w.Tk)("/v1/editor/sql/rounds",{con_uid:F}),{onSuccess:e=>{var l,t;let n=null==e?void 0:null===(l=e.data)||void 0===l?void 0:l[(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.length)-1];n&&N(null==n?void 0:n.round)}}),{run:J,loading:W}=(0,s.Z)(async()=>{var e,l;let t=null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/editor/sql/run",{db_name:t,sql:null==M?void 0:M.sql})},{manual:!0,onSuccess:e=>{var l,t;T({columns:null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.colunms,values:null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.values})}}),{run:z,loading:H}=(0,s.Z)(async()=>{var e,l;let t=null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name,n={db_name:t,sql:null==M?void 0:M.sql};return"chat_dashboard"===A&&(n.chart_type=null==M?void 0:M.showcase),await (0,w.PR)("/api/v1/editor/chart/run",n)},{manual:!0,ready:!!(null==M?void 0:M.sql),onSuccess:e=>{if(null==e?void 0:e.success){var l,t,n,a,i,r,s;T({columns:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:null===(t=l.sql_data)||void 0===t?void 0:t.colunms)||[],values:(null==e?void 0:null===(n=e.data)||void 0===n?void 0:null===(a=n.sql_data)||void 0===a?void 0:a.values)||[]}),(null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.chart_values)?k({type:null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.chart_type,values:null==e?void 0:null===(s=e.data)||void 0===s?void 0:s.chart_values,title:null==M?void 0:M.title,description:null==M?void 0:M.thoughts}):k(void 0)}}}),{run:G,loading:K}=(0,s.Z)(async()=>{var e,l,t,n,a;let i=null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/sql/editor/submit",{conv_uid:F,db_name:i,conv_round:b,old_sql:null==C?void 0:C.sql,old_speak:null==C?void 0:C.thoughts,new_sql:null==M?void 0:M.sql,new_speak:(null===(t=null==M?void 0:null===(n=M.thoughts)||void 0===n?void 0:n.match(/^\n--(.*)\n\n$/))||void 0===t?void 0:null===(a=t[1])||void 0===a?void 0:a.trim())||(null==M?void 0:M.thoughts)})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&J()}}),{run:Y,loading:$}=(0,s.Z)(async()=>{var e,l,t,n,a,i;let r=null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name;return await (0,w.PR)("/api/v1/chart/editor/submit",{conv_uid:F,chart_title:null==M?void 0:M.title,db_name:r,old_sql:null==C?void 0:null===(t=C[D])||void 0===t?void 0:t.sql,new_chart_type:null==M?void 0:M.showcase,new_sql:null==M?void 0:M.sql,new_comment:(null===(n=null==M?void 0:null===(a=M.thoughts)||void 0===a?void 0:a.match(/^\n--(.*)\n\n$/))||void 0===n?void 0:null===(i=n[1])||void 0===i?void 0:i.trim())||(null==M?void 0:M.thoughts),gmt_create:new Date().getTime()})},{manual:!0,onSuccess:e=>{(null==e?void 0:e.success)&&z()}}),{data:Q}=(0,s.Z)(async()=>{var e,l;let t=null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name;return await (0,w.Tk)("/v1/editor/db/tables",{db_name:t,page_index:1,page_size:200})},{ready:!!(null===(e=null==U?void 0:null===(l=U.data)||void 0===l?void 0:l.find(e=>e.round===b))||void 0===e?void 0:e.db_name),refreshDeps:[null===(t=null==U?void 0:null===(i=U.data)||void 0===i?void 0:i.find(e=>e.round===b))||void 0===t?void 0:t.db_name]}),{run:X}=(0,s.Z)(async e=>await (0,w.Tk)("/v1/editor/sql",{con_uid:F,round:e}),{manual:!0,onSuccess:e=>{let l;try{if(Array.isArray(null==e?void 0:e.data))l=null==e?void 0:e.data,I("0");else if("string"==typeof(null==e?void 0:e.data)){let t=JSON.parse(null==e?void 0:e.data);l=t}else l=null==e?void 0:e.data}catch(e){console.log(e)}finally{O(l),Array.isArray(l)?q(null==l?void 0:l[Number(D||0)]):q(l)}}}),ee=a.useMemo(()=>{let e=(l,t)=>l.map(l=>{let a=l.title,i=a.indexOf(p),r=a.substring(0,i),s=a.slice(i+p.length),o=i>-1?(0,n.jsx)(d.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,n.jsxs)("span",{children:[r,(0,n.jsx)("span",{className:"text-[#1677ff]",children:p}),s,(null==l?void 0:l.type)&&(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})}):(0,n.jsx)(d.Z,{title:((null==l?void 0:l.comment)||(null==l?void 0:l.title))+((null==l?void 0:l.can_null)==="YES"?"(can null)":"(can't null)"),children:(0,n.jsxs)("span",{children:[a,(null==l?void 0:l.type)&&(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",className:"pl-0.5",style:{display:"inline"},children:"[".concat(null==l?void 0:l.type,"]")})]})});if(l.children){let n=t?String(t)+"_"+l.key:l.key;return{title:a,showTitle:o,key:n,children:e(l.children,n)}}return{title:a,showTitle:o,key:l.key}});return(null==Q?void 0:Q.data)?e([null==Q?void 0:Q.data]):[]},[p,Q]),el=a.useMemo(()=>{let e=[],l=(t,n)=>{if(t&&!((null==t?void 0:t.length)<=0))for(let a=0;a<t.length;a++){let i=t[a],{key:r,title:s}=i;e.push({key:r,title:s,parentKey:n}),i.children&&l(i.children,r)}};return ee&&l(ee),e},[ee]),et=(e,l)=>{let t;for(let n=0;n<l.length;n++){let a=l[n];a.children&&(a.children.some(l=>l.key===e)?t=a.key:et(e,a.children)&&(t=et(e,a.children)))}return t};return a.useEffect(()=>{b&&X(b)},[X,b]),a.useEffect(()=>{C&&"chat_dashboard"===A&&D&&z()},[D,A,C,z]),a.useEffect(()=>{C&&"chat_dashboard"!==A&&J()},[A,C,J]),(0,n.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,n.jsxs)("div",{className:"bg-[#f8f8f8] border-[var(--joy-palette-divider)] border-b border-solid flex items-center px-3 justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center py-3",children:[(0,n.jsx)(m.Z,{className:"mr-2"}),(0,n.jsx)(u.Z,{className:"h-4 min-w-[240px]",size:"sm",value:b,onChange:(e,l)=>{N(l)},children:null==U?void 0:null===(r=U.data)||void 0===r?void 0:r.map(e=>(0,n.jsx)(v.Z,{value:null==e?void 0:e.round,children:null==e?void 0:e.round_name},null==e?void 0:e.round))})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)(h.Z,{className:"bg-[#1677ff] text-[#fff] hover:bg-[#1c558e]",loading:W||H,onClick:async()=>{"chat_dashboard"===A?z():J()},children:"Run"}),(0,n.jsx)(h.Z,{variant:"outlined",className:"ml-3",loading:K||$,onClick:async()=>{"chat_dashboard"===A?await Y():await G()},children:"Save"})]})]}),(0,n.jsxs)("div",{className:"flex flex-1 overflow-auto",children:[(0,n.jsxs)("div",{className:"text h-full border-[var(--joy-palette-divider)] border-r border-solid p-3 max-h-full overflow-auto",style:{width:"300px"},children:[(0,n.jsx)(E,{style:{marginBottom:8},placeholder:"Search",onChange:e=>{let{value:l}=e.target;if(null==Q?void 0:Q.data){if(l){let e=el.map(e=>e.title.indexOf(l)>-1?et(e.key,ee):null).filter((e,l,t)=>e&&t.indexOf(e)===l);f(e)}else f([]);y(l),S(!0)}}}),(0,n.jsx)(g.Z,{onExpand:e=>{f(e),S(!1)},expandedKeys:o,autoExpandParent:_,treeData:ee,fieldNames:{title:"showTitle"}})]}),(0,n.jsx)("div",{className:"flex flex-col flex-1 max-w-full overflow-hidden",children:Array.isArray(C)?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(x.Z,{className:"h-full",sx:{".ant-tabs-content, .ant-tabs-tabpane-active":{height:"100%"},"& .ant-tabs-card.ant-tabs-top >.ant-tabs-nav .ant-tabs-tab, & .ant-tabs-card.ant-tabs-top >div>.ant-tabs-nav .ant-tabs-tab":{borderRadius:"0"}},children:(0,n.jsx)(j.Z,{className:"h-full",type:"card",activeKey:D,onChange:e=>{I(e),q(null==C?void 0:C[Number(e)])},items:null==C?void 0:C.map((e,l)=>({key:l+"",label:null==e?void 0:e.title,children:(0,n.jsx)("div",{className:"flex flex-col h-full",children:(0,n.jsx)(R,{editorValue:e,handleChange:(e,l)=>{if(M){let t=JSON.parse(JSON.stringify(M));t.sql=e,t.thoughts=l,q(t)}},tableData:L,chartData:P})})}))})})}):(0,n.jsx)(R,{editorValue:C,handleChange:(e,l)=>{q({thoughts:l,sql:e})},tableData:L,chartData:void 0})})]})]})},M=t(69962),q=t(97287),L=t(73141),T=t(45642),D=t(71990),I=e=>{let l=(0,a.useReducer)((e,l)=>({...e,...l}),{...e});return l},B=t(21628),F=e=>{let{queryAgentURL:l,channel:t,queryBody:n,initHistory:r,runHistoryList:s}=e,[o,d]=I({history:r||[]}),c=(0,Z.useSearchParams)(),u=c.get("id"),{refreshDialogList:v}=(0,i.Cg)(),h=new AbortController;(0,a.useEffect)(()=>{r&&d({history:r})},[r]);let x=async(e,a)=>{if(!e)return;let i=[...o.history,{role:"human",context:e}],r=i.length;d({history:i});let s={conv_uid:u,...a,...n,user_input:e,channel:t};if(!(null==s?void 0:s.conv_uid)){B.ZP.error("conv_uid 不存在，请刷新后重试");return}try{await (0,D.L)("".concat("http://127.0.0.1:5000").concat("/api"+l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),signal:h.signal,openWhenHidden:!0,async onopen(e){if(i.length<=1){var l;v();let e=new URLSearchParams(window.location.search);e.delete("initMessage"),null===(l=window.history)||void 0===l||l.replaceState(null,null,"?".concat(e.toString()))}(!e.ok||e.headers.get("content-type")!==D.a)&&e.status>=400&&e.status<500&&429!==e.status&&e.status},onclose(){console.log("onclose")},onerror(e){throw console.log("onerror"),Error(e)},onmessage:e=>{var l,t,n;if(e.data=null===(l=e.data)||void 0===l?void 0:l.replaceAll("\\n","\n"),"[DONE]"===e.data);else if(null===(t=e.data)||void 0===t?void 0:t.startsWith("[ERROR]"))d({history:[...i,{role:"view",context:null===(n=e.data)||void 0===n?void 0:n.replace("[ERROR]","")}]});else{let l=[...i];e.data&&((null==l?void 0:l[r])?l[r].context="".concat(e.data):l.push({role:"view",context:e.data}),d({history:l}))}}})}catch(e){console.log(e),d({history:[...i,{role:"view",context:"请求出错"}]})}};return{handleChatSubmit:x,history:o.history}},A=t(67830),U=t(54842),V=t(80937),J=t(311),W=t(94244),z=t(35086),H=t(53047),G=t(34112),K=t(30530),Y=t(64747),$=t(19700),Q=t(92391),X=t(55749),ee=t(70781),el=t(42599),et=t(99398),en=t(49064),ea=t(15241),ei=t(86362),er=t(50946),es=t(52276),eo=t(53534),ed=t(24946),ec=t(98479),eu=t(81616),ev=function(e){var l,t;let{convUid:i,chatMode:r,fileName:s,onComplete:o,...d}=e,[c,u]=(0,a.useState)(!1),[v,h]=(0,a.useState)([]),[x,m]=(0,a.useState)(),[f,p]=(0,a.useState)(),g=async e=>{var l;if(!e){B.ZP.error("Please select the *.(csv|xlsx|xls) file");return}if(!/\.(csv|xlsx|xls)$/.test(null!==(l=e.file.name)&&void 0!==l?l:"")){B.ZP.error("File type must be csv, xlsx or xls");return}h([e.file])},j=async()=>{u(!0),p("normal");try{let e=new FormData;e.append("doc_file",v[0]);let{success:l,err_msg:t}=await eo.Z.post("/api/v1/chat/mode/params/file/load?conv_uid=".concat(i,"&chat_mode=").concat(r),e,{timeout:36e5,headers:{"Content-Type":"multipart/form-data"},onUploadProgress(e){let l=Math.ceil(e.loaded/(e.total||0)*100);m(l)}});if(!l){B.ZP.error(t);return}B.ZP.success("success"),p("success"),o()}catch(e){p("exception"),B.ZP.error((null==e?void 0:e.message)||"Upload Error")}finally{u(!1)}};return(0,n.jsxs)("div",{className:"w-full",children:[!s&&(0,n.jsxs)("div",{className:"flex items-start",children:[(0,n.jsx)(ea.Z,{placement:"topLeft",title:"Files cannot be changed after upload",children:(0,n.jsx)(ei.default,{disabled:c,className:"mr-1",beforeUpload:()=>!1,fileList:v,name:"file",accept:".csv,.xlsx,.xls",multiple:!1,onChange:g,showUploadList:{showDownloadIcon:!1,showPreviewIcon:!1,showRemoveIcon:!1},itemRender:()=>(0,n.jsx)(n.Fragment,{}),...d,children:(0,n.jsx)(er.ZP,{className:"flex justify-center items-center dark:bg-[#4e4f56] dark:text-gray-200",disabled:c,icon:(0,n.jsx)(ed.Z,{}),children:"Select File"})})}),(0,n.jsx)(er.ZP,{type:"primary",loading:c,className:"flex justify-center items-center",disabled:!v.length,icon:(0,n.jsx)(ec.Z,{}),onClick:j,children:c?100===x?"Analysis":"Uploading":"Upload"})]}),(!!v.length||s)&&(0,n.jsxs)("div",{className:"mt-2 text-gray-500 text-sm flex items-center",children:[(0,n.jsx)(eu.Z,{className:"mr-2"}),(0,n.jsx)("span",{children:null!==(t=null==v?void 0:null===(l=v[0])||void 0===l?void 0:l.name)&&void 0!==t?t:s})]}),("number"==typeof x||!!s)&&(0,n.jsx)(es.Z,{className:"mb-0",percent:s?100:x,size:"small",status:s?"success":f})]})};let eh=Q.z.object({query:Q.z.string().min(1)});var ex=e=>{var l;let{messages:i,dialogue:r,onSubmit:s,readOnly:o,paramsList:d,onRefreshHistory:c,clearIntialMessage:m,setChartsData:f}=e,p=(0,Z.useSearchParams)(),g=p.get("initMessage"),j=p.get("spaceNameOriginal"),y=p.get("id"),b=p.get("scene"),w="chat_dashboard"===b,_=(0,a.useRef)(null),[S,P]=(0,a.useState)(!1),[C,E]=(0,a.useState)(),[R,O]=(0,a.useState)(!1),[M,q]=(0,a.useState)(),[L,T]=(0,a.useState)(i),[D,I]=(0,a.useState)(""),F=(0,$.cI)({resolver:(0,A.F)(eh),defaultValues:{}}),Q=async e=>{let{query:l}=e;try{P(!0),F.reset(),await s(l,{select_param:"chat_excel"===b?null==r?void 0:r.select_param:null==d?void 0:d[C]})}catch(e){}finally{P(!1)}},ea=async()=>{try{var e;let l=new URLSearchParams(window.location.search),t=l.get("initMessage");l.delete("initMessage"),null===(e=window.history)||void 0===e||e.replaceState(null,null,"?".concat(l.toString())),await Q({query:t})}catch(e){console.log(e)}finally{null==m||m()}},ei={overrides:{code:e=>{let{children:l}=e;return(0,n.jsx)(et.Z,{language:"javascript",style:en.Z,children:l})}},wrapper:a.Fragment},er=e=>{let l=e;try{l=JSON.parse(e)}catch(e){console.log(e)}return l},es=(0,a.useMemo)(()=>{if("function"==typeof(null==window?void 0:window.fetch)){let e=t(62631);return t(25204),t(82372),e.default}},[]);return(0,a.useEffect)(()=>{_.current&&_.current.scrollTo(0,_.current.scrollHeight)},[null==i?void 0:i.length]),(0,a.useEffect)(()=>{g&&i.length<=0&&ea()},[g,i.length]),(0,a.useEffect)(()=>{var e,l;d&&(null===(e=Object.keys(d||{}))||void 0===e?void 0:e.length)>0&&E(j||(null===(l=Object.keys(d||{}))||void 0===l?void 0:l[0]))},[d]),(0,a.useEffect)(()=>{if(w){let e=k().cloneDeep(i);e.forEach(e=>{(null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context)&&(e.context=er(null==e?void 0:e.context))}),T(e.filter(e=>["view","human"].includes(e.role)))}else T(i.filter(e=>["view","human"].includes(e.role)))},[w,i]),(0,n.jsxs)("div",{className:"w-full h-full",children:[(0,n.jsxs)(V.Z,{className:"w-full h-full bg-[#fefefe] dark:bg-[#212121]",sx:{table:{borderCollapse:"collapse",border:"1px solid #ccc",width:"100%"},"th, td":{border:"1px solid #ccc",padding:"10px",textAlign:"center"}},children:[(0,n.jsxs)(V.Z,{ref:_,direction:"column",sx:{overflowY:"auto",maxHeight:"100%",flex:1},children:[null==L?void 0:L.map((e,l)=>{var t,a;return(0,n.jsx)(V.Z,{children:(0,n.jsx)(N.Z,{size:"sm",variant:"outlined",color:"view"===e.role?"primary":"neutral",sx:l=>({background:"view"===e.role?"var(--joy-palette-primary-softBg, var(--joy-palette-primary-100, #DDF1FF))":"unset",border:"unset",borderRadius:"unset",padding:"24px 0 26px 0",lineHeight:"24px"}),children:(0,n.jsxs)(x.Z,{sx:{width:"76%",margin:"0 auto"},className:"flex flex-row",children:[(0,n.jsx)("div",{className:"mr-3 inline",children:"view"===e.role?(0,n.jsx)(ee.Z,{}):(0,n.jsx)(X.Z,{})}),(0,n.jsx)("div",{className:"inline align-middle mt-0.5 max-w-full flex-1 overflow-auto",children:w&&"view"===e.role&&"object"==typeof(null==e?void 0:e.context)?(0,n.jsxs)(n.Fragment,{children:["[".concat(e.context.template_name,"]: "),(0,n.jsx)(J.Z,{sx:{color:"#1677ff"},component:"button",onClick:()=>{O(!0),q(l),I(JSON.stringify(null==e?void 0:e.context,null,2))},children:e.context.template_introduce||"暂无介绍"})]}):(0,n.jsx)(n.Fragment,{children:"string"==typeof e.context&&(0,n.jsx)(el.Z,{options:ei,children:null===(t=e.context)||void 0===t?void 0:null===(a=t.replaceAll)||void 0===a?void 0:a.call(t,"\\n","\n")})})})]})})},l)}),S&&(0,n.jsx)(W.Z,{variant:"soft",color:"neutral",size:"sm",sx:{mx:"auto",my:2}})]}),!o&&(0,n.jsx)(x.Z,{className:"bg-[#fefefe] dark:bg-[#212121] before:bg-[#fefefe] before:dark:bg-[#212121]",sx:{position:"relative","&::before":{content:'" "',position:"absolute",top:"-18px",left:"0",right:"0",width:"100%",margin:"0 auto",height:"20px",filter:"blur(10px)",zIndex:2}},children:(0,n.jsxs)("form",{style:{maxWidth:"100%",width:"76%",position:"relative",display:"flex",marginTop:"auto",overflow:"visible",background:"none",justifyContent:"center",marginLeft:"auto",marginRight:"auto",flexDirection:"column",gap:"12px",paddingBottom:"58px",paddingTop:"20px"},onSubmit:e=>{e.stopPropagation(),F.handleSubmit(Q)(e)},children:[(0,n.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[Object.keys(d||{}).length>0&&(0,n.jsx)("div",{className:"flex items-center gap-3",children:(0,n.jsx)(u.Z,{value:C,onChange:(e,l)=>{E(l)},sx:{maxWidth:"100%"},children:null===(l=Object.keys(d||{}))||void 0===l?void 0:l.map(e=>(0,n.jsx)(v.Z,{value:e,children:e},e))})}),"chat_excel"===b&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(ev,{convUid:y,chatMode:b,fileName:null==r?void 0:r.select_param,onComplete:()=>{null==m||m(),null==c||c()}})})]}),(0,n.jsx)(z.ZP,{disabled:"chat_excel"===b&&!(null==r?void 0:r.select_param),className:"w-full h-12",variant:"outlined",endDecorator:(0,n.jsx)(H.ZP,{type:"submit",disabled:S,children:(0,n.jsx)(U.Z,{})}),...F.register("query")})]})})]}),(0,n.jsx)(G.Z,{open:R,onClose:()=>{O(!1)},children:(0,n.jsxs)(K.Z,{"aria-labelledby":"variant-modal-title","aria-describedby":"variant-modal-description",children:[(0,n.jsx)(Y.Z,{}),(0,n.jsxs)(x.Z,{sx:{marginTop:"32px"},children:[!!es&&(0,n.jsx)(es,{mode:"json",value:D,height:"600px",width:"820px",onChange:I,placeholder:"默认json数据",debounceChangePeriod:100,showPrintMargin:!0,showGutter:!0,highlightActiveLine:!0,setOptions:{useWorker:!0,showLineNumbers:!0,highlightSelectedWord:!0,tabSize:2}}),(0,n.jsx)(h.Z,{variant:"outlined",className:"w-full",sx:{marginTop:"12px"},onClick:()=>{if(M)try{let e=k().cloneDeep(L),l=JSON.parse(D);e[M].context=l,T(e),null==f||f(null==l?void 0:l.charts),O(!1),I("")}catch(e){B.ZP.error("JSON 格式化出错")}},children:"Submit"})]})]})})]})};let em=()=>(0,n.jsxs)(N.Z,{className:"h-full w-full flex bg-transparent",children:[(0,n.jsx)(M.Z,{animation:"wave",variant:"text",level:"body2"}),(0,n.jsx)(M.Z,{animation:"wave",variant:"text",level:"body2"}),(0,n.jsx)(q.Z,{ratio:"21/9",className:"flex-1",sx:{["& .".concat(L.Z.content)]:{height:"100%"}},children:(0,n.jsx)(M.Z,{variant:"overlay",className:"h-full"})})]});var ef=()=>{var e;let[l,t]=(0,a.useState)();a.useRef(null);let[r,d]=a.useState(!1),u=(0,Z.useSearchParams)(),{dialogueList:v,refreshDialogList:h}=(0,i.Cg)(),m=u.get("id"),f=u.get("scene"),p=(0,a.useMemo)(()=>(null!==(e=null==v?void 0:v.data)&&void 0!==e?e:[]).find(e=>e.conv_uid===m),[m,v]),{data:g,run:j}=(0,s.Z)(async()=>await (0,w.Tk)("/v1/chat/dialogue/messages/history",{con_uid:m}),{ready:!!m,refreshDeps:[m]}),{data:y,run:b}=(0,s.Z)(async()=>await (0,w.Tk)("/v1/chat/db/list"),{ready:!!f&&!!["chat_with_db_execute","chat_with_db_qa"].includes(f)}),{data:P}=(0,s.Z)(async()=>await (0,w.Tk)("/v1/chat/db/support/type"),{ready:!!f&&!!["chat_with_db_execute","chat_with_db_qa"].includes(f)}),{data:C,run:E}=(0,s.Z)(async()=>await (0,w.Kw)("/v1/chat/mode/params/list?chat_mode=".concat(f)),{ready:!!f,refreshDeps:[m,f]}),{history:R,handleChatSubmit:O}=F({queryAgentURL:"/v1/chat/completions",queryBody:{conv_uid:m,chat_mode:f||"chat_normal"},initHistory:null==g?void 0:g.data,runHistoryList:j});(0,a.useEffect)(()=>{try{var e;let l=null==R?void 0:null===(e=R[R.length-1])||void 0===e?void 0:e.context,n=JSON.parse(l);t((null==n?void 0:n.template_name)==="report"?null==n?void 0:n.charts:void 0)}catch(e){t(void 0)}},[R]);let M=(0,a.useMemo)(()=>{if(l){let e=[],t=null==l?void 0:l.filter(e=>"IndicatorValue"===e.chart_type);t.length>0&&e.push({rowIndex:e.length,cols:t,type:"IndicatorValue"});let n=null==l?void 0:l.filter(e=>"IndicatorValue"!==e.chart_type),a=n.length,i=0;return[[0],[1],[2],[1,2],[1,3],[2,1,2],[2,1,3],[3,1,3],[3,2,3]][a].forEach(l=>{if(l>0){let t=n.slice(i,i+l);i+=l,e.push({rowIndex:e.length,cols:t})}}),e}},[l]);return(0,n.jsxs)(T.Z,{container:!0,spacing:2,className:"h-full",sx:{flexGrow:1},children:[l&&(0,n.jsx)(T.Z,{xs:8,className:"max-h-full",children:(0,n.jsx)("div",{className:"flex flex-col gap-3 h-full",children:null==M?void 0:M.map(e=>(0,n.jsx)("div",{className:"".concat((null==e?void 0:e.type)!=="IndicatorValue"?"flex flex-1 gap-3 overflow-hidden":""),children:e.cols.map(e=>{if("IndicatorValue"===e.chart_type)return(0,n.jsx)("div",{className:"flex flex-row gap-3",children:e.values.map(e=>(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)(N.Z,{sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"justify-around",children:[(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.name}),(0,n.jsx)(c.ZP,{children:e.value})]})})},e.name))},e.chart_uid);if("LineChart"===e.chart_type)return(0,n.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,n.jsx)(N.Z,{className:"h-full",sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"h-full",children:[(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",children:e.chart_desc}),(0,n.jsx)("div",{className:"flex-1 h-full",children:(0,n.jsx)(S.Chart,{padding:[10,20,50,40],autoFit:!0,data:e.values,children:(0,n.jsx)(S.LineAdvance,{shape:"smooth",point:!0,area:!0,position:"name*value",color:"type"})})})]})})},e.chart_uid);if("BarChart"===e.chart_type)return(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)(N.Z,{className:"h-full",sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"h-full",children:[(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",children:e.chart_desc}),(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsxs)(S.Chart,{autoFit:!0,data:e.values,children:[(0,n.jsx)(S.Interval,{position:"name*value",style:{lineWidth:3,stroke:(0,S.getTheme)().colors10[0]}}),(0,n.jsx)(S.Tooltip,{shared:!0})]})})]})})},e.chart_uid);if("Table"===e.chart_type){var l,t;let a=k().groupBy(e.values,"type");return(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)(N.Z,{className:"h-full overflow-auto",sx:{background:"transparent"},children:(0,n.jsxs)(_.Z,{className:"h-full",children:[(0,n.jsx)(c.ZP,{gutterBottom:!0,component:"div",children:e.chart_name}),(0,n.jsx)(c.ZP,{gutterBottom:!0,level:"body3",children:e.chart_desc}),(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsxs)(o.Z,{"aria-label":"basic table",stripe:"odd",hoverRow:!0,borderAxis:"bothBetween",children:[(0,n.jsx)("thead",{children:(0,n.jsx)("tr",{children:Object.keys(a).map(e=>(0,n.jsx)("th",{children:e},e))})}),(0,n.jsx)("tbody",{children:null===(l=Object.values(a))||void 0===l?void 0:null===(t=l[0])||void 0===t?void 0:t.map((e,l)=>{var t;return(0,n.jsx)("tr",{children:null===(t=Object.keys(a))||void 0===t?void 0:t.map(e=>{var t;return(0,n.jsx)("td",{children:(null==a?void 0:null===(t=a[e])||void 0===t?void 0:t[l].value)||""},e)})},l)})})]})})]})})},e.chart_uid)}})},e.rowIndex))})}),!l&&"chat_dashboard"===f&&(0,n.jsx)(T.Z,{xs:8,className:"max-h-full p-6",children:(0,n.jsx)("div",{className:"flex flex-col gap-3 h-full",children:(0,n.jsxs)(T.Z,{container:!0,spacing:2,sx:{flexGrow:1},children:[(0,n.jsx)(T.Z,{xs:8,children:(0,n.jsx)(x.Z,{className:"h-full w-full",sx:{display:"flex",gap:2},children:(0,n.jsx)(em,{})})}),(0,n.jsx)(T.Z,{xs:4,children:(0,n.jsx)(em,{})}),(0,n.jsx)(T.Z,{xs:4,children:(0,n.jsx)(em,{})}),(0,n.jsx)(T.Z,{xs:8,children:(0,n.jsx)(em,{})})]})})}),(0,n.jsx)(T.Z,{xs:"chat_dashboard"===f?4:12,className:"h-full max-h-full",children:(0,n.jsx)("div",{className:"h-full",style:{boxShadow:"chat_dashboard"===f?"0px 0px 9px 0px #c1c0c080":"unset"},children:(0,n.jsx)(ex,{clearIntialMessage:async()=>{await h()},dialogue:p,dbList:null==y?void 0:y.data,runDbList:b,supportTypes:null==P?void 0:P.data,isChartChat:"chat_dashboard"===f,messages:R||[],onSubmit:O,onRefreshHistory:j,paramsList:null==C?void 0:C.data,runParamsList:E,setChartsData:t})})})]})},ep=()=>{let{isContract:e,setIsContract:l}=(0,i.Cg)(),t=(0,Z.useSearchParams)(),a=t.get("scene"),s=a&&["chat_with_db_execute","chat_dashboard"].includes(a);return(0,n.jsxs)(n.Fragment,{children:[!e&&s&&(0,n.jsx)("div",{className:"leading-[3rem] text-right pr-3 mb-3 border-b flex justify-end",children:(0,n.jsxs)("div",{className:"flex items-center cursor-pointer",onClick:()=>{l(!e)},children:[(0,n.jsx)(r.Z,{style:{marginRight:"4px"}}),"Change Mode"]})}),e?(0,n.jsx)(O,{}):(0,n.jsx)(ef,{})]})}},57931:function(e,l,t){"use strict";t.d(l,{ZP:function(){return d},Cg:function(){return s}});var n=t(9268),a=t(89081),i=t(89749),r=t(86006);let[s,o]=function(){let e=r.createContext(void 0);return[function(){let l=r.useContext(e);if(void 0===l)throw Error("useCtx must be inside a Provider with a value");return l},e.Provider]}();var d=e=>{let{children:l}=e,[t,s]=r.useState(!1),{run:d,data:c,refresh:u}=(0,a.Z)(async()=>await (0,i.Tk)("/v1/chat/dialogue/list"),{manual:!0});return(0,n.jsx)(o,{value:{isContract:t,dialogueList:c,setIsContract:s,queryDialogueList:d,refreshDialogList:u},children:l})}},53534:function(e,l,t){"use strict";var n=t(24214);let a=n.Z.create({baseURL:"http://127.0.0.1:5000"});a.defaults.timeout=1e4,a.interceptors.response.use(e=>e.data,e=>Promise.reject(e)),l.Z=a},89749:function(e,l,t){"use strict";t.d(l,{Ej:function(){return u},Kw:function(){return d},PR:function(){return c},Tk:function(){return o}});var n=t(21628),a=t(53534),i=t(84835);let r={"content-type":"application/json"},s=e=>{if(!(0,i.isPlainObject)(e))return JSON.stringify(e);let l={...e};for(let e in l){let t=l[e];"string"==typeof t&&(l[e]=t.trim())}return JSON.stringify(l)},o=(e,l)=>{if(l){let t=Object.keys(l).filter(e=>void 0!==l[e]&&""!==l[e]).map(e=>"".concat(e,"=").concat(l[e])).join("&");t&&(e+="?".concat(t))}return a.Z.get("/api"+e,{headers:r}).then(e=>e).catch(e=>{n.ZP.error(e),Promise.reject(e)})},d=(e,l)=>{let t=s(l);return a.Z.post("/api"+e,{body:t,headers:r}).then(e=>e).catch(e=>{n.ZP.error(e),Promise.reject(e)})},c=(e,l)=>a.Z.post(e,l,{headers:r}).then(e=>e).catch(e=>{n.ZP.error(e),Promise.reject(e)}),u=(e,l)=>a.Z.post(e,l).then(e=>e).catch(e=>{n.ZP.error(e),Promise.reject(e)})}},function(e){e.O(0,[2180,7991,5757,7282,4518,7487,8358,4344,1191,9081,6259,2569,2606,5086,1630,1767,4341,1506,7746,2657,1160,9253,5769,1744],function(){return e(e.s=86066)}),_N_E=e.O()}]);